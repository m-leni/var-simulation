<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VaR Analysis - VaR Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .asset-row { border-bottom: 1px solid #eee; padding-bottom: 1rem; }
        .asset-row:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">VaR Simulation</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/stock-analysis">Stock Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/var-analysis">VaR Analysis</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Value at Risk (VaR) Analysis</h2>
        
        {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-body">
                <ul class="nav nav-tabs" id="varTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" 
                                type="button" role="tab" aria-selected="true">Single Asset</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" 
                                type="button" role="tab" aria-selected="false">Portfolio</button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="varTabContent">
                    <!-- Single Asset VaR -->
                    <div class="tab-pane fade show active" id="single" role="tabpanel">
                        <div class="alert alert-info mb-3">
                            <h5>Historical VaR Calculation</h5>
                            <p>Calculate Value at Risk based on historical returns data. Enter your returns series and parameters below.</p>
                        </div>
                        <form method="POST" action="/var-analysis/single" id="varForm">
                            <div class="mb-3">
                                <label for="returns" class="form-label">Returns Series</label>
                                <textarea class="form-control" id="returns" name="returns" rows="5" required
                                          placeholder="Enter return values, one per line or comma-separated (e.g., 0.02, -0.01, 0.03)"></textarea>
                                <small class="text-muted">Enter historical returns as decimal values (e.g., 0.02 for 2% return)</small>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="confidence_level" class="form-label">Confidence Level (0.0-1.0)</label>
                                        <input type="number" class="form-control" id="confidence_level" 
                                               name="confidence_level" value="0.95" min="0" max="1"
                                               step="0.01" required>
                                        <small class="text-muted">Default: 0.95 (95% confidence)</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="investment_value" class="form-label">Investment Value</label>
                                        <input type="number" class="form-control" id="investment_value"
                                               name="investment_value" value="1.0" min="0" step="0.01" required>
                                        <small class="text-muted">Default: 1.0 (for percentage VaR)</small>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Calculate Historical VaR</button>
                        </form>
                    </div>

                    <script>
                        // Add form validation
                        document.getElementById('varForm').addEventListener('submit', function(e) {
                            const returns = document.getElementById('returns').value;
                            const confidence = parseFloat(document.getElementById('confidence_level').value);
                            const investment = parseFloat(document.getElementById('investment_value').value);
                            
                            // Validate returns format
                            let returnValues;
                            try {
                                returnValues = returns.includes(',') 
                                    ? returns.split(',').map(x => parseFloat(x.trim()))
                                    : returns.split('\n').map(x => parseFloat(x.trim()));
                                
                                if (returnValues.some(isNaN)) {
                                    throw new Error('Invalid return values');
                                }
                            } catch (error) {
                                e.preventDefault();
                                alert('Please enter valid return values (numbers only)');
                                return;
                            }
                            
                            // Validate confidence level
                            if (confidence <= 0 || confidence >= 1) {
                                e.preventDefault();
                                alert('Confidence level must be between 0 and 1');
                                return;
                            }
                            
                            // Validate investment value
                            if (investment <= 0) {
                                e.preventDefault();
                                alert('Investment value must be greater than 0');
                                return;
                            }
                        });

                        // Add returns format helper
                        document.getElementById('returns').addEventListener('paste', function(e) {
                            // Allow paste event to complete
                            setTimeout(() => {
                                // Clean up the input
                                const input = this.value;
                                const cleaned = input
                                    .split(/[\n,\t]/)
                                    .map(x => x.trim())
                                    .filter(x => x)
                                    .map(x => {
                                        // Try to parse as number and format
                                        const num = parseFloat(x);
                                        return isNaN(num) ? x : num.toString();
                                    })
                                    .join('\n');
                                this.value = cleaned;
                            }, 0);
                        });
                    </script>

                    <!-- Portfolio VaR -->
                    <div class="tab-pane fade" id="portfolio" role="tabpanel">
                        <form method="POST" action="/var-analysis/portfolio">
                            <div id="portfolio-assets">
                                <div class="row mb-3 asset-row">
                                    <div class="col-md-6">
                                        <label class="form-label">Ticker Symbol</label>
                                        <input type="text" class="form-control ticker-input" name="tickers[]" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Weight</label>
                                        <input type="number" class="form-control weight-input" name="weights[]" 
                                               required min="0" max="1" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" onclick="addAsset()">Add Asset</button>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="portfolio_days" class="form-label">Historical Days</label>
                                        <input type="number" class="form-control" id="portfolio_days" name="days"
                                               value="252" min="1" max="1000">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="portfolio_confidence" class="form-label">Confidence Level</label>
                                        <input type="number" class="form-control" id="portfolio_confidence" 
                                               name="confidence_level" value="0.95" min="0.8" max="0.99"
                                               step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="portfolio_investment" class="form-label">Total Investment</label>
                                        <input type="number" class="form-control" id="portfolio_investment"
                                               name="investment_value" value="100000" min="1">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="portfolio_method" class="form-label">VaR Method</label>
                                <select class="form-select" id="portfolio_method" name="method">
                                    <option value="historical">Historical Simulation</option>
                                    <option value="parametric">Parametric (Normal Distribution)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Calculate Portfolio VaR</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if parametric_var %}
        <div class="card">
            <div class="card-body">
                <h4>VaR Analysis Results</h4>
                <div class="alert alert-info">
                    {% if portfolio_var %}
                    <h5>Portfolio VaR: ${{ "%.2f"|format(portfolio_var) }}</h5>
                    {% else %}
                    <h5>Historical VaR: ${{ "%.2f"|format(historical_var) }}</h5>
                    <h5>Parametric VaR: ${{ "%.2f"|format(parametric_var) }}</h5>
                    {% endif %}
                    <p>This means there is a {{ "%.1f"|format(confidence_level * 100) }}% probability that your investment will not lose more than the VaR amount in value over the next day.</p>
                </div>
                
                {% if asset_metrics %}
                <h5 class="mt-4">Portfolio Components</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Weight</th>
                                <th>Value</th>
                                <th>Individual VaR</th>
                                <th>Historical Returns</th>
                                <th>Volatility</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in asset_metrics %}
                            <tr>
                                <td>{{ asset.ticker }}</td>
                                <td>{{ "%.2f"|format(asset.weight * 100) }}%</td>
                                <td>${{ "%.2f"|format(asset.value) }}</td>
                                <td>${{ "%.2f"|format(asset.var) }}</td>
                                <td>{{ "%.2f"|format(asset.avg_return * 100) }}%</td>
                                <td>{{ "%.2f"|format(asset.volatility * 100) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {% if metrics %}
                <div class="mt-4">
                    <h5>Risk Metrics</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Average Daily Return
                            <span class="badge bg-primary rounded-pill">{{ "%.2f"|format(metrics.avg_return * 100) }}%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Daily Volatility
                            <span class="badge bg-primary rounded-pill">{{ "%.2f"|format(metrics.volatility * 100) }}%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Maximum Daily Loss
                            <span class="badge bg-danger rounded-pill">{{ "%.2f"|format(metrics.max_loss * 100) }}%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Maximum Daily Gain
                            <span class="badge bg-success rounded-pill">{{ "%.2f"|format(metrics.max_gain * 100) }}%</span>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function addAsset() {
            const container = document.getElementById('portfolio-assets');
            const newRow = document.createElement('div');
            newRow.className = 'row mb-3 asset-row';
            newRow.innerHTML = `
                <div class="col-md-5">
                    <label class="form-label">Ticker Symbol</label>
                    <input type="text" class="form-control ticker-input" name="tickers[]" required>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Weight</label>
                    <input type="number" class="form-control weight-input" name="weights[]" 
                           required min="0" max="1" step="0.01">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm mb-2" onclick="removeAsset(this)">Remove</button>
                </div>
            `;
            container.appendChild(newRow);
        }

        function removeAsset(button) {
            button.closest('.asset-row').remove();
            validateWeights();
        }

        function validateWeights() {
            const weightInputs = document.querySelectorAll('.weight-input');
            const sum = Array.from(weightInputs)
                .map(input => parseFloat(input.value) || 0)
                .reduce((a, b) => a + b, 0);
            
            const sumDisplay = document.getElementById('weight-sum');
            if (sumDisplay) {
                sumDisplay.textContent = sum.toFixed(3);
                sumDisplay.className = Math.abs(sum - 1) < 0.0001 ? 'text-success' : 'text-danger';
            }
            return Math.abs(sum - 1) < 0.0001;
        }

        // Add weight validation to forms
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const weightInputs = this.querySelectorAll('.weight-input');
                if (weightInputs.length > 0 && !validateWeights()) {
                    e.preventDefault();
                    alert('Portfolio weights must sum to 1');
                }
            });
        });

        // Add validation on weight change
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('weight-input')) {
                validateWeights();
            }
        });

        // Initialize with one asset row
        if (document.getElementById('portfolio-assets') && 
            document.getElementById('portfolio-assets').children.length === 0) {
            addAsset();
        }
    </script>
</body>
</html>